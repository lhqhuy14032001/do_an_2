<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý danh mục</title>
</head>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<style>
    label.error {
        padding: 5px 0;
        min-width: 100%;
        color: red;
        display: block;
    }

    .img-category {
        width: 100px;
        height: 100px;
    }

    td {
        vertical-align: middle;
    }
</style>

<body>
<section id="header">
    <%- include('../header.ejs') %>
</section>
<div class="container my-3 col-8">
    <button type="button" class="btn-add-category-modal btn btn-outline-success btn-lg float-right"
            data-bs-toggle="modal" data-bs-target="#add_product_modal">
        Thêm Danh Mục
    </button>
    <!-- Modal add new category -->
    <div class="modal fade" id="add_product_modal" tabindex="-1" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="exampleModalLabel">Thêm danh mục</h4>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">Vui lòng chọn hình ảnh danh mục với các định dạng sau:
                        jpg | JPG | jpeg | JPEG | png | PNG | gif | GIF
                    </div>
                    <form id="add-category" method="post" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="category_name">Tên danh mục</label>
                            <input type="text" name="category_name" id="category_name" class=" mt-1 form-control"
                                   placeholder="Danh mục">
                        </div>
                        <div class="mb-3">
                            <label>Hình ảnh danh mục</label>
                            <input type="file" name="image-category" id="img_category"
                                   class="mt-1 form-control">
                        </div>
                        <button id="btn-add-category" class="btn btn-success">Thêm Danh Mục</button>
                        <button type="submit" class="btn btn-danger" data-bs-dismiss="modal">Đóng</button>
                    </form>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <!-- Modal add new category -->
    <!--    Modal update-->
    <!--    <button type="button" class="btn-add-category-modal btn btn-outline-success btn-lg float-right"-->
    <!--            data-bs-toggle="modal" data-bs-target="#add_product_modal">-->
    <!--        Thêm Danh Mục-->
    <!--    </button>-->
    <div class="modal fade" id="edit_product_modal" tabindex="-1" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="exampleModalLabel">Chỉnh sửa danh mục</h4>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="notification alert alert-danger" role="alert"></div>
                    <form id="edit-category" method="post" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="category_name_update">Tên danh mục</label>
                            <input type="text" name="category_name_update" id="category_name_update"
                                   class=" mt-1 form-control"
                                   placeholder="Danh mục">
                        </div>
                        <div class="mb-3 wrapper-img">
                            <p>Hình ảnh danh mục:</p>
                            <img class="img-category" id="img-prev-update" src=""/>
                        </div>
                        <div class="mb-3">
                            <label>Hình ảnh danh mục</label>
                            <input type="file" name="image_category_update" id="image_category_update"
                                   class="mt-1 form-control">
                        </div>
                        <button id="btn-edit-category" class="btn btn-warning">Sửa
                        </button>
                    </form>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <!--    Modal update-->

    <section class="category-list mt-3">
        <h1>Danh sách danh mục</h1>
        <div class="notification alert alert-danger" role="alert"></div>
        <div class="notification_success alert alert-success" role="alert"></div>
        <% if (categoryList.length != []){ %>
            <table id="category-list" class=" table table-striped ">
                <thead>
                <tr>
                    <th>Tên danh mục</th>
                    <th>Hình ảnh</th>
                    <th>Chức năng</th>
                </tr>
                </thead>
                <tbody class="category-list">
                <% categoryList.forEach((category, index) => { %>
                    <tr>
                        <td><%= category.category_name %></td>
                        <td>
                            <div class="wrapper-img">
                                <img class="img-category" src="<%= category.category_img %>"/>
                            </div>
                        </td>
                        <td>
                            <button
                                    data-bs-toggle="modal" data-bs-target="#edit_product_modal"
                                    onclick="getEditCategory(<%= category.id %>)"
                                    class="btn-delete btn btn-warning">Sửa
                            </button>
                            <button onclick="deleteCategory(<%= category.id %>)"
                                    class="btn-delete btn
                        btn-danger">Xoá
                            </button>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        <% }else{ %>
            <tr>
                <h5 class="text-danger">Hiện tại, không có danh mục trong danh sách</h5>
            </tr>
        <% } %>
    </section>

</div>
<%- include('../footer.ejs') -%>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>
<script src="/js/admin/product_manage.js"></script>
<script>
    let categoryName = $('#category_name_update');
    let imgPrevUpdate = $('#img-prev-update');
    let btnEdit = $('#btn-edit-category');
    let prevCategoryName = '';
    let deleteCategory = (categoryID) => {
        let data = {id: categoryID}
        $.ajax({
            method: "POST",
            data: data,
            url: '/admin/delete-category',
            success: (data) => {
                try {
                    if (data.err == 1) {
                        alert(data.msg);
                    } else {
                        location.reload();
                    }
                } catch (error) {
                    console.error('>>>Something is wrong', error)
                }
            }
        })
    };
    let getEditCategory = (categoryID) => {
        let data = {id: categoryID};
        $.ajax({
            method: 'GET',
            data: data,
            url: '/admin/category',
            success: (data) => {
                if (data.categoryInfo.err == 1) {
                    notification.show();
                    notification.html('Hiện tại không thể cập nhật, do không lấy được thông tin của danh mục cần cập nhật');
                }
                categoryName.val(data.categoryInfo.data[0].category_name);
                imgPrevUpdate.attr('src', data.categoryInfo.data[0].category_img)
                prevCategoryName = data.categoryInfo.data[0].category_name;
                btnEdit.on('click', (event) => {
                    event.preventDefault();
                    handleEditCategory(categoryID);
                });
            }
        })
    };
    let handleEditCategory = (categoryID, preImg) => {
        let fileSelect = $('#image_category_update');
        let categoryName = $('#category_name_update').val() != '' ? $('#category_name_update').val() : prevCategoryName;
        let files = fileSelect[0].files;
        let file = files[0];
        let formData = new FormData();
        formData.append('category_name', categoryName);
        formData.append('image_category_update', file);
        formData.append('id', categoryID);
        $.ajax({
            method: 'POST',
            contentType: false,
            data: formData,
            url: '/admin/edit-category',
            processData: false,
            success: (data) => {
                if (data.err == 0) {
                    $('#edit_product_modal').modal('toggle');
                    $('.notification_success').show();
                    $('.notification_success').html(data.msg);
                    setTimeout(hideNotification, 2000);
                }
            }
        })
    };
    let hideNotification = () => {
        location.reload()
    }

</script>
</body>

</html>